/**
 * machina - A library for creating powerful and flexible finite state machines. Loosely inspired by Erlang/OTP's gen_fsm behavior.
 * Author: Jim Cowart (http://ifandelse.com)
 * Version: v1.1.2
 * Url: http://machina-js.org/
 * License(s): MIT, GPL
 */
(function(t,e){"function"==typeof define&&define.amd?define(["lodash"],function(i){return e(i,t)}):"object"==typeof module&&module.exports?module.exports=e(require("lodash")):t.machina=e(t._,t)})(this,function(t,e,i){function n(){return{initialState:"uninitialized",eventListeners:{"*":[]},states:{},namespace:b.makeFsmNamespace(),useSafeEmit:!1,hierarchy:{},pendingDelegations:{}}}function s(){return{inputQueue:[],targetReplayState:"",state:i,priorState:i,priorAction:"",currentAction:"",currentActionArgs:i,inExitHandler:!1}}function a(t,e){for(var i=[],n=e||0;n<t.length;n++)i[n]=t[n];return i}function r(t){if(t){var e={};return"object"==typeof t?t.factory?e=t:e.factory=function(){return t}:"function"==typeof t&&(e.factory=t),e.instance=e.factory(),e}}function o(t,e){return e.on("*",function(e,i){switch(e){case"nohandler":i.ticket||i.delegated||i.namespace===t.namespace||(i.args[1].bubbling=!0),"_reset"!==i.inputType&&t.handle.apply(t,i.args);break;case"handling":var n=i.ticket;n&&t.pendingDelegations[n]&&delete t.pendingDelegations[n],t.emit(e,i);break;default:t.emit(e,i)}})}function c(){for(var t=[],e="0123456789abcdef",i=0;36>i;i++)t[i]=e.substr(Math.floor(16*Math.random()),1);return t[14]="4",t[19]=e.substr(3&t[19]|8,1),t[8]=t[13]=t[18]=t[23]="-",t.join("")}function l(e){t.extend(this,e),t.defaults(this,n()),this.initialize.apply(this,arguments),C.emit(v,this)}var u=[].slice,h="transition",p="handling",d="handled",f="nohandler",g="transition",y="invalidstate",m="deferred",v="newfsm",_=["states","initialState"],A=function(e,i){var n,s=this,a={},r=function(){};return n=e&&e.hasOwnProperty("constructor")?e.constructor:function(){var e=u.call(arguments,0);e[0]=e[0]||{};var i,n=e[0].states||{};i=t.merge(t.cloneDeep(a),{states:n}),i.initialState=e[0].initialState||this.initialState,t.extend(e[0],i),s.apply(this,e)},t.merge(n,s),r.prototype=s.prototype,n.prototype=new r,e&&(t.extend(n.prototype,e),t.merge(a,t.transform(e,function(t,e,i){-1!==_.indexOf(i)&&(t[i]=e)}))),i&&t.merge(n,i),n.prototype.constructor=n,n.__super__=s.prototype,n},b={makeFsmNamespace:function(){var t=0;return function(){return"fsm."+t++}}(),listenToChild:o,getLeaklessArgs:a,getDefaultOptions:n,getDefaultClientMeta:s,createUUID:c},E={emit:function(e){var i=a(arguments);this.eventListeners["*"]&&t.each(this.eventListeners["*"],function(t){if(this.useSafeEmit)try{t.apply(this,i)}catch(e){console&&"undefined"!=typeof console.log&&console.log(e.stack)}else t.apply(this,i)},this),this.eventListeners[e]&&t.each(this.eventListeners[e],function(t){if(this.useSafeEmit)try{t.apply(this,i.slice(1))}catch(e){console&&"undefined"!=typeof console.log&&console.log(e.stack)}else t.apply(this,i.slice(1))},this)},on:function(t,e){var i=this;return i.eventListeners=i.eventListeners||{"*":[]},i.eventListeners[t]||(i.eventListeners[t]=[]),i.eventListeners[t].push(e),{eventName:t,callback:e,off:function(){i.off(t,e)}}},off:function(e,i){this.eventListeners=this.eventListeners||{"*":[]},e?this.eventListeners[e]=i?t.without(this.eventListeners[e],i):[]:this.eventListeners={}}},S="__machina__";t.extend(l.prototype,{initialize:function(){},initClient:function(t){var e=this.initialState;if(!e)throw new Error("You must specify an initial state for this FSM");if(!this.states[e])throw new Error("The initial state specified does not exist in the states object.");this.transition(t,e)},ensureClientMeta:function(e){if("object"!=typeof e)throw new Error("An FSM client must be an object.");return e[S]=e[S]||{},e[S][this.namespace]||(e[S][this.namespace]=t.cloneDeep(b.getDefaultClientMeta()),this.initClient(e)),e[S][this.namespace]},buildEventPayload:function(e,i){return t.isPlainObject(i)?t.extend(i,{client:e,namespace:this.namespace}):{client:e,data:i||null,namespace:this.namespace}},getHandlerArgs:function(t,e){var i=t.slice(0),n=i[1];return"object"==typeof n&&i.splice(1,1,n.inputType),e?i:[i[0]].concat(i.slice(2))},handle:function(e,n){var s=n;if("undefined"==typeof n)throw new Error("The input argument passed to the FSM's handle method is undefined. Did you forget to pass the input name?");"string"==typeof n&&(s={inputType:n,delegated:!1,ticket:i});var r=this.ensureClientMeta(e),o=a(arguments);"object"!=typeof n&&o.splice(1,1,s),r.currentActionArgs=o.slice(1);var c,l,u,h,g,y=r.state,m=this.states[y],v=!1;if(!r.inExitHandler)if(u=m._child&&m._child.instance,!u||this.pendingDelegations[s.ticket]||s.bubbling){s.ticket&&this.pendingDelegations[s.ticket]&&delete this.pendingDelegations[s.ticket],c=m[s.inputType]?s.inputType:"*",v="*"===c,l=m[c]||this[c]||this["*"],g=r.state+"."+c,r.currentAction=g;var _=this.buildEventPayload(e,{inputType:s.inputType,delegated:s.delegated,ticket:s.ticket});l?(this.emit(p,_),"function"==typeof l?h=l.apply(this,this.getHandlerArgs(o,v)):(h=l,this.transition(e,l)),this.emit(d,_)):this.emit(f,t.extend({args:o},_)),r.priorAction=r.currentAction,r.currentAction=""}else s.ticket=s.ticket||b.createUUID(),s.delegated=!0,this.pendingDelegations[s.ticket]={delegatedTo:u.namespace},h=u.handle.apply(u,o);return h},transition:function(t,e){var i,n=this.ensureClientMeta(t),s=n.state,a=this.states[s],o=this.states[e];if(!n.inExitHandler&&e!==s){if(o){o._child&&(o._child=r(o._child),i=o._child&&o._child.instance),a&&a._onExit&&(n.inExitHandler=!0,a._onExit.call(this,t),n.inExitHandler=!1),a&&a._child&&a._child.instance&&this.hierarchy[a._child.instance.namespace]&&this.hierarchy[a._child.instance.namespace].off(),n.targetReplayState=e,n.priorState=s,n.state=e,i&&(this.hierarchy[i.namespace]=b.listenToChild(this,i));var c=this.buildEventPayload(t,{fromState:n.priorState,action:n.currentAction,toState:e});return this.emit(g,c),o._onEnter&&o._onEnter.call(this,t),i&&i.handle(t,"_reset"),void(n.targetReplayState===e&&this.processQueue(t,h))}this.emit(y,this.buildEventPayload(t,{state:n.state,attemptedState:e}))}},deferUntilTransition:function(t,e){var i=this.ensureClientMeta(t);if(i.currentActionArgs){var n={type:h,untilState:e,args:i.currentActionArgs};i.inputQueue.push(n);var s=this.buildEventPayload(t,{state:i.state,queuedArgs:n});this.emit(m,s)}},deferAndTransition:function(t,e){this.deferUntilTransition(t,e),this.transition(t,e)},processQueue:function(e){var i=this.ensureClientMeta(e),n=function(t){return!t.untilState||t.untilState===i.state},s=t.filter(i.inputQueue,n);i.inputQueue=t.difference(i.inputQueue,s),t.each(s,function(t){this.handle.apply(this,[e].concat(t.args))},this)},clearQueue:function(e,i){var n=this.ensureClientMeta(e);if(i){var s=function(t){return i?t.untilState!==i:!0};n.inputQueue=t.filter(n.inputQueue,s)}else n.inputQueue=[]},compositeState:function(t){var e=this.ensureClientMeta(t),i=e.state,n=this.states[i]._child&&this.states[i]._child.instance;return n&&(i+="."+n.compositeState(t)),i}},E),l.extend=A;var T={constructor:function(){l.apply(this,arguments),this.ensureClientMeta()},initClient:function(){var t=this.initialState;if(!t)throw new Error("You must specify an initial state for this FSM");if(!this.states[t])throw new Error("The initial state specified does not exist in the states object.");this.transition(t)},handleOverload:function(e,n){var s=n;if("undefined"==typeof n)throw new Error("The input argument passed to the FSM's handle method is undefined. Did you forget to pass the input name?");"string"==typeof n&&(s={inputType:n,delegated:!1,ticket:i});var r=this.ensureClientMeta(e),o=a(arguments);"object"!=typeof n&&o.splice(1,1,s),r.currentActionArgs=o.slice(1);var c,l,u,h,g,y=r.state,m=this.states[y],v=!1;if(!r.inExitHandler)if(u=m._child&&m._child.instance,!u||this.pendingDelegations[s.ticket]||s.bubbling){s.ticket&&this.pendingDelegations[s.ticket]&&delete this.pendingDelegations[s.ticket],c=m[s.inputType]?s.inputType:"*",v="*"===c,l=m[c]||this[c]||this["*"],g=r.state+"."+c,r.currentAction=g;var _=this.buildEventPayload(e,{inputType:s.inputType,delegated:s.delegated,ticket:s.ticket});l?(this.emit(p,_),"function"==typeof l?(o.push(m._data),h=l.apply(this,this.getHandlerArgs(o,v))):(h=l,this.transition(e,l,n)),this.emit(d,_)):this.emit(f,t.extend({args:o},_)),r.priorAction=r.currentAction,r.currentAction=""}else s.ticket=s.ticket||b.createUUID(),s.delegated=!0,this.pendingDelegations[s.ticket]={delegatedTo:u.namespace},o.push(m._data),h=u.handle.apply(u,o);return h},transitionOverload:function(t,e,i){var n,s=this.ensureClientMeta(t),a=s.state,o=this.states[a],c=this.states[e];if(!s.inExitHandler&&e!==a){if(c){c._child&&(c._child=r(c._child),n=c._child&&c._child.instance),o&&o._onExit&&(s.inExitHandler=!0,o._onExit.call(this,o._data,t),s.inExitHandler=!1),o&&(o._data=null),o&&o._child&&o._child.instance&&this.hierarchy[o._child.instance.namespace]&&this.hierarchy[o._child.instance.namespace].off(),s.targetReplayState=e,s.priorState=a,s.state=e,n&&(this.hierarchy[n.namespace]=b.listenToChild(this,n));var l=this.buildEventPayload(t,{fromState:s.priorState,action:s.currentAction,toState:e});return this.emit(g,l),c._onEnter?(c._onEnter.call(this,i,t),c._data=i):i?c._data=i:o&&o._data&&(c._data=o._data),n&&n.handle(t,"_reset"),void(s.targetReplayState===e&&this.processQueue(t,h))}this.emit(y,this.buildEventPayload(t,{state:s.state,attemptedState:e}))}},deferAndTransitionOverload:function(t,e,i){this.deferUntilTransition(t,e),this.transition(t,e,i)},ensureClientMeta:function(){return this._stamped||(this._stamped=!0,t.defaults(this,t.cloneDeep(s())),this.initClient()),this},ensureClientArg:function(t){var e=t;return"object"!=typeof e[0]||"inputType"in e[0]||e[0]===this?("object"!=typeof e[0]||"object"==typeof e[0]&&"inputType"in e[0])&&e.unshift(this):e.splice(0,1,this),e},getHandlerArgs:function(t,e){var i=t,n=i[1];return"object"==typeof inputType&&i.splice(1,1,n.inputType),i.slice(e?1:2)},buildEventPayload:function(){var e=this.ensureClientArg(b.getLeaklessArgs(arguments)),i=e[1];return t.isPlainObject(i)?t.extend(i,{namespace:this.namespace}):{data:i||null,namespace:this.namespace}}};t.each(["deferUntilTransition","processQueue","clearQueue"],function(t){T[t]=function(){var e=this.ensureClientArg(b.getLeaklessArgs(arguments));return l.prototype[t].apply(this,e)}}),T.deferAndTransition=function(){var t=this.ensureClientArg(b.getLeaklessArgs(arguments));return T.prototype.deferAndTransitionOverload.apply(this,t)},T.handle=function(){var t=this.ensureClientArg(b.getLeaklessArgs(arguments));return T.prototype.handleOverload.apply(this,t)},T.transition=function(){var t=this.ensureClientArg(b.getLeaklessArgs(arguments));return T.prototype.transitionOverload.apply(this,t)},T=l.extend(T);var k={constructor:function(){l.apply(this,arguments),this.ensureClientMeta()},initClient:function(){var t=this.initialState;if(!t)throw new Error("You must specify an initial state for this FSM");if(!this.states[t])throw new Error("The initial state specified does not exist in the states object.");this.transition(t)},ensureClientMeta:function(){return this._stamped||(this._stamped=!0,t.defaults(this,t.cloneDeep(s())),this.initClient()),this},ensureClientArg:function(t){var e=t;return"object"!=typeof e[0]||"inputType"in e[0]||e[0]===this?("object"!=typeof e[0]||"object"==typeof e[0]&&"inputType"in e[0])&&e.unshift(this):e.splice(0,1,this),e},getHandlerArgs:function(t,e){var i=t,n=i[1];return"object"==typeof inputType&&i.splice(1,1,n.inputType),i.slice(e?1:2)},buildEventPayload:function(){var e=this.ensureClientArg(b.getLeaklessArgs(arguments)),i=e[1];return t.isPlainObject(i)?t.extend(i,{namespace:this.namespace}):{data:i||null,namespace:this.namespace}}};t.each(["handle","transition","deferUntilTransition","processQueue","clearQueue"],function(t){k[t]=function(){var e=this.ensureClientArg(b.getLeaklessArgs(arguments));return l.prototype[t].apply(this,e)}}),k=l.extend(k);var C=t.merge(E,{Fsm:k,BehavioralFsm:l,DynamicFsm:T,utils:b,eventListeners:{newFsm:[]}});return C});